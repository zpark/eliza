<!DOCTYPE html>
<html>
    <head>
        <title>Eliza Admin Panel</title>
        <style>
            :root {
                --primary: #2d7ff9;
                --bg-dark: #0f1011;
                --bg-panel: #18191c;
                --bg-card: #212226;
                --border: #2a2b30;
                --text: #e4e5e7;
                --text-secondary: #9da1a7;
            }
            
            body {
                font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin: 0;
                background: var(--bg-dark);
                color: var(--text);
                line-height: 1.5;
            }

            .navbar {
                background: var(--bg-panel);
                padding: 1rem 2rem;
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .navbar h1 {
                margin: 0;
                font-size: 1.25rem;
                font-weight: 500;
            }

            .main-container {
                display: grid;
                grid-template-columns: 300px 1fr;
                height: calc(100vh - 60px);
            }

            .sidebar {
                background: var(--bg-panel);
                border-right: 1px solid var(--border);
                padding: 1.5rem;
            }

            .bot-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .bot-item {
                padding: 0.75rem 1rem;
                margin: 0.5rem 0;
                background: var(--bg-card);
                border-radius: 6px;
                border: 1px solid var(--border);
                cursor: pointer;
                transition: all 0.2s;
            }

            .bot-item:hover {
                border-color: var(--primary);
            }

            .bot-item.active {
                background: var(--primary);
                color: white;
            }

            .content {
                padding: 2rem;
                overflow-y: auto;
            }

            .room-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
                gap: 1.5rem;
            }

            .room-card {
                background: var(--bg-panel);
                border-radius: 8px;
                border: 1px solid var(--border);
                overflow: hidden;
            }

            .room-header {
                padding: 1rem;
                background: var(--bg-card);
                border-bottom: 1px solid var(--border);
            }

            .room-id {
                font-family: 'Monaco', 'Menlo', monospace;
                font-size: 0.85rem;
                color: var(--text-secondary);
            }

            .room-stats {
                display: flex;
                gap: 1.5rem;
                padding: 1rem;
                border-bottom: 1px solid var(--border);
            }

            .stat {
                display: flex;
                flex-direction: column;
            }

            .stat-label {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-secondary);
            }

            .stat-value {
                font-size: 1.25rem;
                font-weight: 500;
            }

            .memory-list {
                max-height: 300px;
                overflow-y: auto;
                padding: 0.5rem;
            }

            .memory-item {
                padding: 0.75rem;
                border-bottom: 1px solid var(--border);
            }

            .memory-timestamp {
                font-size: 0.75rem;
                color: var(--text-secondary);
                margin-bottom: 0.25rem;
            }

            .memory-content {
                color: var(--text);
            }

            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background: var(--bg-panel);
            }
            ::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 4px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #383a3f;
            }

            .content-header {
                margin-bottom: 1.5rem;
            }

            .tab-group {
                display: flex;
                gap: 0.5rem;
                border-bottom: 1px solid var(--border);
                padding-bottom: 1rem;
            }

            .tab-btn {
                background: var(--bg-card);
                border: 1px solid var(--border);
                color: var(--text);
                padding: 0.5rem 1rem;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .tab-btn:hover {
                border-color: var(--primary);
            }

            .tab-btn.active {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .log-container {
                background: var(--bg-panel);
                border-radius: 8px;
                border: 1px solid var(--border);
                height: calc(100vh - 180px);
                overflow-y: auto;
                font-family: 'Monaco', 'Menlo', monospace;
                font-size: 0.9rem;
            }

            .log-entry {
                padding: 0.5rem 1rem;
                border-bottom: 1px solid var(--border);
                display: flex;
                gap: 1rem;
                align-items: flex-start;
            }

            .log-timestamp {
                color: var(--text-secondary);
                white-space: nowrap;
            }

            .log-message {
                flex: 1;
            }

            .log-success {
                color: #4caf50;
            }

            .command-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 1rem;
                padding: 1rem;
            }

            .command-card {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                background: var(--bg-panel);
                border-radius: 8px;
                border: 1px solid var(--border);
                padding: 1.25rem;
                transition: all 0.2s;
            }

            .command-card:hover {
                border-color: var(--primary);
            }

            .command-name {
                font-size: 1.1rem;
                font-weight: 500;
                color: var(--primary);
                margin-bottom: 0.5rem;
            }

            .command-description {
                color: var(--text-secondary);
                font-size: 0.9rem;
                line-height: 1.5;
            }

            .error-message {
                color: #ff4d4d;
                padding: 1rem;
                text-align: center;
                background: var(--bg-card);
                border-radius: 8px;
                margin: 1rem;
            }

            .command-content {
                margin-bottom: 1rem;
            }

            .command-actions {
                display: flex;
                gap: 0.5rem;
                margin-top: auto;
            }

            .command-button {
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 4px;
                padding: 0.5rem 1rem;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s;
            }

            .command-button:hover {
                background: #2468cc;
            }

            .command-params {
                margin: 0.5rem 0;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .param-input {
                background: var(--bg-card);
                border: 1px solid var(--border);
                color: var(--text);
                padding: 0.5rem;
                border-radius: 4px;
                font-size: 0.9rem;
            }

            .param-input:focus {
                border-color: var(--primary);
                outline: none;
            }

            .command-result {
                margin-top: 0.5rem;
                padding: 0.5rem;
                background: var(--bg-card);
                border-radius: 4px;
                font-family: monospace;
                font-size: 0.9rem;
                white-space: pre-wrap;
                display: none;
            }

            .command-result.show {
                display: block;
            }

            .command-result.success {
                color: #4caf50;
            }

            .command-result.error {
                color: #ff4d4d;
            }

            .message-input-container {
                display: flex;
                gap: 0.5rem;
                padding: 1rem;
                background: var(--bg-card);
                border-top: 1px solid var(--border);
            }

            .message-input {
                flex: 1;
                background: var(--bg-panel);
                border: 1px solid var(--border);
                color: var(--text);
                padding: 0.75rem;
                border-radius: 4px;
                font-size: 0.9rem;
                resize: none;
                min-height: 20px;
                max-height: 150px;
            }

            .message-input:focus {
                border-color: var(--primary);
                outline: none;
            }

            .send-button {
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 4px;
                padding: 0.5rem 1rem;
                cursor: pointer;
                font-size: 0.9rem;
                transition: all 0.2s;
            }

            .send-button:hover {
                background: #2468cc;
            }

            .room-card {
                display: flex;
                flex-direction: column;
                height: 500px; /* Fixed height for better layout */
            }

            .memory-list {
                flex: 1;
                overflow-y: auto;
                padding: 0.5rem;
                display: flex;
                flex-direction: column-reverse; /* Show newest messages at bottom */
            }
        </style>
    </head>
    <body>
        <nav class="navbar">
            <h1>ðŸ¤– Eliza Admin Panel</h1>
        </nav>
        
        <div class="main-container">
            <aside class="sidebar">
                <div id="botList"></div>
            </aside>
            
            <main class="content">
                <!-- Tab Navigation -->
                <div class="content-header">
                    <div class="tab-group">
                        <button class="tab-btn active" data-tab="rooms">Rooms</button>
                        <button class="tab-btn" data-tab="commands">Commands</button>
                    </div>
                </div>

                <!-- Tab Contents -->
                <div class="tab-contents">
                    <!-- Rooms Tab -->
                    <div id="rooms" class="tab-content active">
                        <div class="room-grid"></div>
                    </div>

                    <!-- Commands Tab -->
                    <div id="commands" class="tab-content">
                        <div class="command-container"></div>
                    </div>
                </div>
            </main>
        </div>

        <script>
            let selectedBot = null;
            let activeTab = 'rooms';

            // Updated tab switching function
            function switchTab(tabName) {
                console.log('Switching to tab:', tabName);
                activeTab = tabName;
                
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('active', content.id === tabName);
                });

                // Fetch data for the active tab
                if (tabName === 'commands') {
                    fetchCommands();
                } else if (tabName === 'rooms' && selectedBot) {
                    updateRoomList(selectedBot);
                }
            }

            // Updated room list update function
            async function updateRoomList(botId) {
                try {
                    const rooms = await fetchRooms(botId);
                    const roomsWithDetails = await Promise.all(rooms.map(async room => {
                        const details = await fetchRoomDetails(botId, room.id);
                        return { ...room, ...details };
                    }));

                    const roomGrid = document.querySelector('.room-grid');
                    if (roomGrid) {
                        roomGrid.innerHTML = roomsWithDetails.map(room => `
                            <div class="room-card">
                                <div class="room-header">
                                    <div class="room-id">${room.id}</div>
                                </div>
                                <div class="room-stats">
                                    <div class="stat">
                                        <span class="stat-label">Messages</span>
                                        <span class="stat-value">${room.messageCount}</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">Last Active</span>
                                        <span class="stat-value">${room.lastActive}</span>
                                    </div>
                                </div>
                                <div class="memory-list">
                                    ${(room.memories || []).slice(0,5).map(memory => `
                                        <div class="memory-item">
                                            <div class="memory-timestamp">
                                                ${new Date(memory.createdAt).toLocaleString()}
                                            </div>
                                            <div class="memory-content">${memory.content.text}</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="message-input-container">
                                    <textarea 
                                        class="message-input" 
                                        placeholder="Type a message..."
                                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage('${room.id}', this.value); this.value = ''; }"
                                    ></textarea>
                                    <button 
                                        class="send-button"
                                        onclick="sendMessage('${room.id}', this.parentElement.querySelector('.message-input').value)"
                                    >
                                        Send
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (error) {
                    console.error('Error updating room list:', error);
                }
            }

            // Add event listeners for tab buttons
            document.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('.tab-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        switchTab(button.dataset.tab);
                    });
                });
            });

            async function fetchRooms(botId) {
                const response = await fetch(`/bots/${botId}/rooms`);
                if (!response.ok) {
                    console.error('Failed to fetch rooms:', await response.text());
                    return [];
                }
                return await response.json();
            }

            async function fetchRoomDetails(botId, roomId) {
                try {
                    const response = await fetch(`/bots/${botId}/rooms/${roomId}/memories`);
                    if (!response.ok) {
                        console.error('Failed to fetch room details:', await response.text());
                        return { memories: [], lastActive: 'No activity' };
                    }
                    const memories = await response.json();
                    return {
                        memories,
                        lastActive: memories.length ? new Date(memories[0].createdAt).toLocaleString() : 'No activity'
                    };
                } catch (error) {
                    console.error('Error fetching room details:', error);
                    return { memories: [], lastActive: 'Error fetching data' };
                }
            }

            async function fetchBots() {
                try {
                    const response = await fetch('/bots');
                    if (!response.ok) {
                        console.error('Failed to fetch bots:', await response.text());
                        return;
                    }
                    const bots = await response.json();
                    
                    const botList = document.getElementById('botList');
                    botList.innerHTML = `
                        <ul class="bot-list">
                            ${bots.map(bot => `
                                <li class="bot-item ${selectedBot === bot.id ? 'active' : ''}" 
                                    onclick="selectBot('${bot.id}')">
                                    ${bot.name}
                                </li>
                            `).join('')}
                        </ul>
                    `;

                    if (selectedBot) {
                        await updateRoomList(selectedBot);
                    }
                } catch (error) {
                    console.error('Error fetching bots:', error);
                }
            }

            async function selectBot(botId) {
                selectedBot = botId;
                await updateRoomList(botId);
                await fetchBots(); // Refresh bot list to show active state
            }

            async function fetchCommands() {
                try {
                    const commandContainer = document.querySelector('.command-container');
                    if (!commandContainer) return;

                    const response = await fetch('/commands');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const commands = await response.json();
                    
                    commandContainer.innerHTML = commands.map(cmd => `
                        <div class="command-card" id="cmd-${cmd.name}">
                            <div class="command-content">
                                <div class="command-name">${cmd.name}</div>
                                <div class="command-description">${cmd.description}</div>
                                <div class="command-params">
                                    <input type="text" 
                                        class="param-input" 
                                        placeholder="Enter parameters (JSON format)"
                                        value="{}"
                                    >
                                </div>
                            </div>
                            <div class="command-actions">
                                <button class="command-button" onclick="executeCommand('${cmd.name}')">
                                    Execute
                                </button>
                            </div>
                            <div class="command-result"></div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error fetching commands:', error);
                    commandContainer.innerHTML = `
                        <div class="error-message">Failed to load commands: ${error.message}</div>
                    `;
                }
            }

            async function executeCommand(commandName) {
                if (!selectedBot) {
                    alert('Please select a bot first');
                    return;
                }

                const commandCard = document.getElementById(`cmd-${commandName}`);
                const paramInput = commandCard.querySelector('.param-input');
                const resultDiv = commandCard.querySelector('.command-result');

                try {
                    // Parse parameters from input
                    const params = JSON.parse(paramInput.value || '{}');

                    // Execute command
                    const response = await fetch(`/bots/${selectedBot}/execute/${commandName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(params)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();

                    // Show result
                    resultDiv.textContent = JSON.stringify(result, null, 2);
                    resultDiv.classList.remove('error');
                    resultDiv.classList.add('success', 'show');
                } catch (error) {
                    console.error('Error executing command:', error);
                    resultDiv.textContent = `Error: ${error.message}`;
                    resultDiv.classList.remove('success');
                    resultDiv.classList.add('error', 'show');
                }
            }

            async function sendMessage(roomId, message) {
                if (!selectedBot || !message.trim()) return;

                try {
                    const response = await fetch(`/bots/${selectedBot}/rooms/${roomId}/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message.trim() })
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    // Clear input and refresh room
                    const input = document.querySelector(`textarea[data-room="${roomId}"]`);
                    if (input) input.value = '';
                    
                    // Wait a moment for the message to be processed
                    setTimeout(() => updateRoomList(selectedBot), 1000);
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message: ' + error.message);
                }
            }

            // Initialize
            fetchBots();
            setInterval(fetchBots, 30000);
        </script>
    </body>
</html> 